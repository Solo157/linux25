ДЗ. Работа с LVM

Будем работать с этими блочными устройствами.
![img_3.png](imgs/HW3/img_3.png)

Создали VG, с размером 5гб, как в PV. Также видим, что VG содержит PV /dev/sdb.
![img_4.png](imgs/HW3/img_4.png)

Отобразим информацию по LV, который создали на базе VG. Видим, что он размером около 4гб, т.е. 80% от VG.
Понимаем, что в VG еще осталось 20% (примерно 1гб)
![img_5.png](imgs/HW3/img_5.png)

Используя команды vgs and lvs видим такую же инфорацию как и выше, только в сжатом виде.
![img_6.png](imgs/HW3/img_6.png)

Создаем еще один LV, но фикс. размером 100мб.
![img_7.png](imgs/HW3/img_7.png)

Создали FS на LV test. Затем смонтировали на каталог /data. Как видим, /data - каталог монтирования на FS ext4
![img_8.png](imgs/HW3/img_8.png)

Расширение LVM

Допустим нужно добавить пространство к /dev/otus/test. Создаем новый PV, затем его подключаем к VG.
![img_9.png](imgs/HW3/img_9.png)
![img_10.png](imgs/HW3/img_10.png)

Заполнили LV полностью.
![img_11.png](imgs/HW3/img_11.png)

Теперь увеличиваем LV за счет недавно дополненного PV. Расширили до 8.71Гб.
![img_12.png](imgs/HW3/img_12.png)

Видно, что файловая система не изменилась. Производим resize FS. Видим, что FS расширилась.
![img_13.png](imgs/HW3/img_13.png)
![img_14.png](imgs/HW3/img_14.png)

Допустим Вы забыли оставить место на снапшоты. Можно уменьшить существующий LV с помощью команды lvreduce, но перед этим необходимо отмонтировать файловую систему, проверить её на ошибки и уменьшить ее размер:
Изменяем размер до 6Гб.
Отмонтировали /data. Проверили на ошибки блочное устройство LV, затем заресайзили FS до 6Гб. И затем заресайзили сам LV до 6гб.
После чего снова смонтировали в /data и проверили, что LV otus стал 6Гб.
![img_15.png](imgs/HW3/img_15.png)

Работа со снапшотами

Создали снепшот.
![img_16.png](imgs/HW3/img_16.png)
![img_17.png](imgs/HW3/img_17.png)

Примонтировали снепшот. Убедились, что файл присутствует от орин.LV и отмонтировали.
![img_18.png](imgs/HW3/img_18.png)

Отмонтировали также оригин LV, но я уже ранее запустил процесс слияния. Как почитал в интернетах, вроде надо ждать
какое-то время.
![img_19.png](imgs/HW3/img_19.png)
Еще почитал, надо было просто ребутнутся. Ребутнулся, затем примонтировал оригин. LV и увидел снова мой удаленный файл.
![img_20.png](imgs/HW3/img_20.png)


Работа с LVM-RAID

Создали PV, VG, LV mirror. Видим, что mirrir LV чуть более 1Гб. Это данные, которые зеркалируются.
То есть нам потребовалось условно 2Гб для создания зеркала с хранением 1Гб данных. Похоже он вычислил 2400мб, разделил
на 2 и получил по 1200мб для каждого PV, но у меня один PV 2гб, другой 1гб. Поэтому LVM взял то макс количество мб из которого
сможет сделать зеркало, а это определяется размером минимального PV.
![img_21.png](imgs/HW3/img_21.png)


Домашнее задание

Уменьшить том под / до 8G

Создал новый PV, затем VG, затем LV и создал файловую систему ext4.
![img_22.png](imgs/HW3/img_22.png)

Сделал монтирование в /mnt и туда скопировал все из /
![img_23.png](imgs/HW3/img_23.png)

Переключились на систему /mnt. Делаем lsblk и видим такую картину.
![img_24.png](imgs/HW3/img_24.png)
![img_25.png](imgs/HW3/img_25.png)

Теперь нам нужно изменить размер старой VG и вернуть на него рут. Для этого удаляем старый LV размером в 10G и создаём новый на 8G:
У меня старый VG это ubuntu--vg-ubuntu--lv размером 10Гб. Буду изменять его размер с 10Гб до 8гб.
Удалил старый LV, создал новый.
![img_26.png](imgs/HW3/img_26.png)

Проделываю те же операции, что и выше - т.е. копирую обратно файлы и монтирую каталоги. Пока не перезагружаюсь.
![img_27.png](imgs/HW3/img_27.png)

Пока не перезагружаемся и не выходим из под chroot - мы можем заодно перенести /var.
Выделить том под /var в зеркало

Создали LV зеркало lv_var на 950Мб.
![img_28.png](imgs/HW3/img_28.png)

Создаем на нем ФС и перемещаем туда /var.
![img_30.png](imgs/HW3/img_30.png)
![img_29.png](imgs/HW3/img_29.png)

В общем закинули все из var в зеркало, а затем его примонтировали в /var. Т.е. на текущем этапе имеем в зеркале
данные из каталога var.
![img_31.png](imgs/HW3/img_31.png)

Правим fstab и перезагружаемся.
![img_32.png](imgs/HW3/img_32.png)

После перезагрузки удаляем. Также видим, что ubuntu--vg-ubuntu--lv уже 8гб.
![img_33.png](imgs/HW3/img_33.png)
![img_34.png](imgs/HW3/img_34.png)

Выделить том под /home

Делаем то же самое, что и для var. Создали LV, примонтировали, скинули туда файлы из оригинального home и отмонтировали.
Затем уже LV примонтировали к home.
![img_35.png](imgs/HW3/img_35.png)

Правим fstab. Чтобы файловая система в примонтированной к home была известна корневой/текущей системе при загрузке.
![img_36.png](imgs/HW3/img_36.png)

Работа со снапшотами

Создали файлы в home и создали LV снапшот. Затем удалили часть файлов.
![img_37.png](imgs/HW3/img_37.png)

Видим, что снапшот 100Мб и заполнен он на 0.01%.
![img_38.png](imgs/HW3/img_38.png)

Восстанавливаем из снапшота. Отмонтировали home, сделали merge снапшота на оригинальный LV и получили все удаленные файлы.
![img_39.png](imgs/HW3/img_39.png)